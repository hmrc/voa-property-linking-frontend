@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.ApplicationConfig
@import controllers.detailedvaluationrequest.AvailableRequestDetailedValuation
@import models.dvr.cases.check.projection.CaseDetails

@import views.html.dvr.challengeCasesDetails
@import views.html.dvr.checkCasesDetails
@import utils.Formatters

@this(
  mainLayout: views.html.mainLayout,
  govukButton: GovukButton,
  govukDetails: GovukDetails,
  govukWarningText: GovukWarningText,
  govukTable: GovukTable,
  govukTabs: GovukTabs,
  govukSummaryList: GovukSummaryList
)

@(model: AvailableRequestDetailedValuation,
        submissionId: String,
        owner: Boolean,
        authorisationId: Long,
        clientOrgName: Option[String],
        backUrl: String,
        startCheckUrl: String,
        checksAndChallenges: Option[(List[CaseDetails], List[CaseDetails])])(implicit request: Request[_], messages: Messages, config: ApplicationConfig)


@address = @{Formatters.capitalisedAddress(model.address)}
@checkCases = @{checksAndChallenges.fold(List[CaseDetails]())(_._1)}
@challengeCases = @{checksAndChallenges.fold(List[CaseDetails]())(_._2)}

@evaluateRoute(t: String) = @{
    if(owner) {
        controllers.detailedvaluationrequest.routes.DvrController.myOrganisationRequestDetailedValuationRequestFile(submissionId, model.valuationId, t).url
    } else {
        controllers.detailedvaluationrequest.routes.DvrController.myClientsRequestDetailedValuationRequestFile(submissionId, model.valuationId, t).url
    }
}

  @titleCaption = @{
    if (owner) {
        messages("available.requestvaluation.ip.titleCaption")
    } else {
        messages("available.requestvaluation.agent.titleCaption", clientOrgName.getOrElse(""))
    }
  }

@valuationTabContent = {
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <h2 class="govuk-heading-l">@messages("available.requestvaluation.valuationTab.title")</h2>
            <p class="govuk-body"><a class="govuk-link" href="@evaluateRoute(model.valuation)">@messages("available.requestvaluation.downloadValuationLink")</a></p>

            <h2 class="govuk-heading-l">@messages("available.requestvaluation.changeValuation")</h2>
            @if(model.isWelshProperty) {
                <p class="govuk-body">@Html(messages("available.requestvaluation.p1.welshProperty"))</p>
            } else {
                <p class="govuk-body">@Html(messages("available.requestvaluation.p1.englishProperty"))</p>
                <p class="govuk-body">@Html(messages("available.requestvaluation.p2", evaluateRoute(model.check)))</p>
            }
            <p class="govuk-body">@messages("available.requestvaluation.p3")</p>

            @govukWarningText(WarningText(
                iconFallbackText = "Warning",
                content = Text(messages("available.requestvaluation.warning"))
            ))
            @govukButton(Button(content = Text(messages("available.requestvaluation.dvrCheck.startCheck")), href = Some(startCheckUrl), attributes = Map("id" -> "valuationtab-start-check")))
        </div>
    </div>
}



@checkCasesTabTitle = @{
    if(checkCases.isEmpty){
        messages("available.requestvaluation.checksTab.noCases.title")
    } else {
        messages("available.requestvaluation.checksTab.title", checkCases.size)
    }
}

@checkCasesTabContent = @{
    checkCasesDetails(submissionId, owner, model.uarn, authorisationId, model.valuationId, checkCases, evaluateRoute(model.check), startCheckUrl)(govukButton, govukTable, govukDetails, govukWarningText)
}

@challengeCasesTabContent = {
    @challengeCasesDetails(authorisationId, challengeCases, owner, submissionId)(govukTable)
}

@tabs = @{
   val valuation: TabItem = TabItem(
        id = Some("valuation-tab"),
        label = messages("available.requestvaluation.valuationTab.title"),
        panel = TabPanel(
            content = HtmlContent(valuationTabContent)
        )
    )
    val check: TabItem = TabItem(
        id = Some("check-cases-tab"),
        label = checkCasesTabTitle,
        panel = TabPanel(
            content = HtmlContent(checkCasesTabContent)
        )
    )
    val challenge: TabItem = TabItem(
            id = Some("challenge-cases-tab"),
            label = messages("available.requestvaluation.challengesTab.title", challengeCases.size),
            panel = TabPanel(
              content = HtmlContent(challengeCasesTabContent)
            )
          )

    Seq(
        Some(valuation),
        Some(check).filterNot(_ => model.isDraftList),
        Some(challenge).filterNot(_ => model.isDraftList || challengeCases.isEmpty)
    ).flatten
}

@mainLayout(pageTitle = address, backUri = Some(backUrl), mainClass = Some("govuk-grid-column-full")) {

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <span class="govuk-caption-l" id="client-name">@titleCaption</span>
            <h1 id="assessment-address" class="govuk-heading-l">@address</h1>

            @govukSummaryList(SummaryList(
                rows = Seq(
                    SummaryListRow(
                        key = Key(
                            content = Text(messages("common.localAuthorityReference")),
                            classes = "govuk-summary-list__key govuk-!-padding-right-1 govuk-!-display-inline"
                        ),
                        value = Value(
                            content = Text(model.baRef),
                            classes = "govuk-summary-list__value govuk-!-display-inline"
                        )
                    )
                ),
                classes = "govuk-summary-list--no-border"
            ))
        </div>
    </div>

    @govukTabs(Tabs(items = tabs))

    <p class="govuk-body"><a rel="nofollow" href="javascript:window.print()" class="govuk-link print-link">@messages("available.requestvaluation.print")</a></p>
    <br/>

}