@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.utils.Formatters
@import config.ApplicationConfig
@import controllers.detailedvaluationrequest.AvailableRequestDetailedValuation
@import models.dvr.cases.check.CheckType
@import models.dvr.cases.check.projection.CaseDetails
@import models.dvr.cases.check.StartCheckForm
@import views.html.dvr.tabs._

@this(
  mainLayout: views.html.mainLayout,
  govukButton: GovukButton,
  govukDetails: GovukDetails,
  govukWarningText: GovukWarningText,
  govukTable: GovukTable,
  govukTabs: GovukTabs,
  govukSummaryList: GovukSummaryList,
  govukRadios: GovukRadios,
  govukErrorSummary: GovukErrorSummary,
  formWithCSRF: FormWithCSRF,
  govukInsetText: GovukInsetText
)

@(model: AvailableRequestDetailedValuation, startCheckForm: Form[StartCheckForm])(implicit request: Request[_], messages: Messages, config: ApplicationConfig)


@address = @{Formatters.capitalisedAddress(model.address)}
@checkCases = @{model.checksAndChallenges.fold(List[CaseDetails]())(_._1)}
@challengeCases = @{model.checksAndChallenges.fold(List[CaseDetails]())(_._2)}

@evaluateRoute = @{ t: String =>
    if(model.owner) {
        controllers.detailedvaluationrequest.routes.DvrController.myOrganisationRequestDetailedValuationRequestFile(model.submissionId, model.valuationId, t).url
    } else {
        controllers.detailedvaluationrequest.routes.DvrController.myClientsRequestDetailedValuationRequestFile(model.submissionId, model.valuationId, t).url
    }
}

@titleCaption = @{
    if (model.owner) {
        messages("available.requestvaluation.ip.titleCaption")
    } else {
        messages("available.requestvaluation.agent.titleCaption", model.clientOrgName)
    }
}

@checkCasesTabTitle = @{
    if(checkCases.isEmpty){
        messages("available.requestvaluation.checksTab.noCases.title")
    } else {
        messages("available.requestvaluation.checksTab.title", checkCases.size)
    }
}

@agentsTabTitle = @{
    model.agentTabData match {
        case Some(data) if data.nonEmpty => messages("available.requestvaluation.agentsTab.title", data.size)
        case _ => messages("available.requestvaluation.agentsTab.noAgents.title")
    }
}

@valuationTabContent = @{valuationTab(model, evaluateRoute)(govukButton, govukInsetText, govukWarningText)}

@startCheckTabContent = @{
    startCheckTab(model, startCheckForm)(govukButton, govukDetails, govukRadios, formWithCSRF)
}

@checkCasesTabContent = @{
    checkCasesDetailsTab(model.submissionId, model.owner, model.uarn, model.authorisationId, model.valuationId, model.listYear, checkCases, evaluateRoute(model.check), "#start-check-tab")(govukButton, govukTable, govukDetails, govukWarningText)
}

@challengeCasesTabContent = @{
    challengeCasesDetailsTab(model.authorisationId, challengeCases, model.owner, model.submissionId, model.valuationId, model.uarn)(govukTable)
}

@agentsTabContent = @{agentsTab(model)(govukTable)}

@tabs = @{
   val valuation: TabItem = TabItem(
        id = Some("valuation-tab"),
        label = messages("available.requestvaluation.valuationTab.title"),
        panel = TabPanel(
            content = HtmlContent(valuationTabContent)
        )
    )
    val startCheck: TabItem = TabItem(
        id = Some("start-check-tab"),
        label = messages("available.requestvaluation.startCheckTab.title"),
        panel = TabPanel(
            content = HtmlContent(startCheckTabContent)
        )
    )
    val check: TabItem = TabItem(
        id = Some("check-cases-tab"),
        label = checkCasesTabTitle,
        panel = TabPanel(
            content = HtmlContent(checkCasesTabContent)
        )
    )
    val challenge: TabItem = TabItem(
            id = Some("challenge-cases-tab"),
            label = messages("available.requestvaluation.challengesTab.title", challengeCases.size),
            panel = TabPanel(
              content = HtmlContent(challengeCasesTabContent)
            )
          )
    val agents: TabItem = TabItem(
            id = Some("agents-tab"),
            label = agentsTabTitle,
            panel = TabPanel(
              content = HtmlContent(agentsTabContent)
            )
          )

    Seq(
        Some(valuation),
        Some(startCheck).filterNot(_ => model.isDraftList),
        Some(check).filterNot(_ => model.isDraftList),
        Some(challenge).filterNot(_ => model.isDraftList || challengeCases.isEmpty),
        Some(agents).filterNot(_ => !model.owner)
    ).flatten
}

@mainLayout(pageTitle = address, backUri = Some(model.backUrl), mainClass = Some("govuk-grid-column-full")) {
    @if(startCheckForm.hasErrors){
        @govukErrorSummary(ErrorSummary(
            errorList = startCheckForm.errors.headOption.map(e => ErrorLink(
                href = Some("#checkType_internal"),
                content = Text(messages(e.message)),
                attributes = Map("id" -> "error-link"))
            ).toList,
            title = Text(messages("error.summary.title")),
            attributes = Map("id" -> "error-summary")))
    }

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <span class="govuk-caption-l" id="client-name">@titleCaption</span>
            <h1 id="assessment-address" class="govuk-heading-l">@address</h1>

            @govukSummaryList(SummaryList(
                rows = Seq(
                    SummaryListRow(
                        key = Key(
                            content = Text(messages("common.localAuthorityReference")),
                            classes = "govuk-summary-list__key govuk-!-padding-right-1 govuk-!-display-inline"
                        ),
                        value = Value(
                            content = Text(model.baRef),
                            classes = "govuk-summary-list__value govuk-!-display-inline"
                        )
                    )
                ),
                classes = "govuk-summary-list--no-border"
            ))
        </div>
    </div>

    @govukTabs(Tabs(items = tabs))

    <p class="govuk-body"><a rel="nofollow" href="javascript:window.print()" class="govuk-link print-link">@messages("available.requestvaluation.print")</a></p>
    <br/>

    @for(activeTabId <- model.activeTabId) {
        <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function() {
            location.hash = "@activeTabId";
            @if(startCheckForm.hasErrors){
            @* https://stackoverflow.com/a/2099337/81520 setTimeout makes focus() work *@
            setTimeout(function (){document.getElementById("error-summary").focus();}, 0);
            }
        });
      </script>
    }
}