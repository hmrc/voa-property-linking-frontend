@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import binders.propertylinks._
@import controllers.propertyLinking.routes._
@import config.ApplicationConfig
@import models.upscan._
@import models._
@import views.html.includes.assessmentHeading
@import actions.propertylinking.requests.LinkingSessionRequest
@import helpers._
@import models.EvidenceType
@import binders.propertylinks.EvidenceChoices.EvidenceChoices

@this(govukButton: GovukButton, mainLayout: views.html.mainLayout, formWithCSRF: FormWithCSRF)

@(
        evidenceType: EvidenceType,
        evidenceChoice: EvidenceChoices,
        submissionId: String,
        errors: List[String] = Nil,
        uploadedFiles: Map[String, UploadedFileDetails] = Map()
)(implicit request: LinkingSessionRequest[_], messages: Messages, config: ApplicationConfig)

@title = @{
    (request.ses.clientDetails, evidenceType) match {
        case (Some(_), Lease) => {messages("uploadEvidence.lease.client.title")}
        case (Some(_), License) => {messages("uploadEvidence.license.client.title")}
        case (None, Lease) => {messages("uploadEvidence.lease.title")}
        case (None, License) => {messages("uploadEvidence.license.title")}
        case (Some(_), _)    => {messages("uploadRatesBill.show.client.title")}
        case _          => {messages("uploadRatesBill.show.title")}
    }
}

@mainLayout(
    pageTitle = title,
    backUri = Some(controllers.propertyLinking.routes.ChooseEvidenceController.show.url),
    hasErrors = errors.nonEmpty
) {

    @if(errors.nonEmpty) {
        <div class="govuk-error-summary" aria-labelledby="error-summary-heading" role="alert" tabindex="-1" data-module="govuk-error-summary">

            <h2 class="govuk-error-summary__title" id="error-summary-heading">@messages("error.summary.title")</h2>
            <div class="govuk-error-summary__body">
                <ul class="govuk-list govuk-error-summary__list">
                @errors.map { error =>
                    <li><a href="#newFileButton">@messages(error)</a></li>
                }
                </ul>
            </div>
        </div>
    }
    <div id="errorsList"></div>

    @assessmentHeading(request.ses.localAuthorityReference, request.ses.address)

    <span class="govuk-caption-l">@messages("caption.add.property")</span>
    <div id="newFileGroup" class="govuk-form-group @if(errors.nonEmpty) {govuk-form-group--error}">

        <h1 id="page-header" class="govuk-heading-l govuk-!-margin-bottom-3">@title</h1>

        <div id="fileTypesText" class="govuk-hint">@messages("fileUpload.allowedTypes")</div>

        @formWithCSRF(action = UploadController.initiate(evidenceChoice), 'enctype -> "multipart/form-data", 'id -> "uploadForm") {
            <div class="govuk-!-display-none" id="initiateFields"></div>

            @if(uploadedFiles.size < 1) {
                <label class="govuk-label" for="newFile">
                    <span class="govuk-visually-hidden">@messages("fileupload.chooseFile")</span>
                    <input type="file" id="newFile" name="file" class="govuk-file-upload " tabindex="-1" style="position: absolute;
                        left: -9999px;
                        top: -9999px;
                        z-index: -9999" accept=".xls,.xlsb,.xlsx,.pdf,.docx,.doc,.jpg,.png">
                </label>
                @errors.map { error =>
                    <p id="file-upload-1-error" class="govuk-error-message">
                        <span class="govuk-visually-hidden">@messages("accessibility.error.label")</span> @messages(error)
                    </p>
                }
                <input id="newFileButton" class="govuk-file-upload" name="file-upload-1" type="file">
                }
        </div>

    <div class="message-warning govuk-!-display-none" id="message-warning"><p class="govuk-body">@messages("fileUpload.pleaseWait")</p></div>

    @if(uploadedFiles.nonEmpty) {
        <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">
                @messages("fileUpload.descriptionList.key")
                </dt>
                <dd class="govuk-summary-list__value">
                @uploadedFiles.map { case (fileReference, upload) =>
                    @upload.fileMetadata.toDisplayFileName
                </dd>
                <dd class="govuk-summary-list__actions">
                    <button id="remove-file" type="submit" class="govuk-body govuk-link" formaction="@UploadController.remove(fileReference, evidenceChoice)">
                    @messages("fileUpload.descriptionList.action")
                    </button>
                </dd>
                }
            </div>
        </dl>
    }
}
    @formWithCSRF(action = UploadController.continue(evidenceChoice)) {
        @govukButton(Button(
            content = Text(messages("label.continue")),
            attributes = Map("id" -> "continue")
        ))
    }

    <div class="govuk-!-display-none">
    <span id="businessRatesAttachmentsRemoveFileURL">@{s"/business-rates-property-linking/my-organisation/claim/property-links/evidence/RATES_BILL/upload/remove?fileReference="}</span>
    <span id="businessRatesAttachmentsInitiateUploadURL">@{s"${UploadController.initiate(evidenceChoice)}"}</span>
    <span id="businessRatesAttachmentsFileUploadURL">@{s"${UploadController.show(evidenceChoice)}"}</span>
    <span id="errorsUpscan">@Html(messages("error.upscan.unavailable"))</span>
    <span id="errorsFileSizeTooLarge">@messages("error.businessRatesAttachment.file.size.exceed.max.limit")</span>
    <span id="errorsBusinessRatesAttachmentUnsupportedFiles">@messages("error.businessRatesAttachment.does.not.support.file.types")</span>
    <span id="errorsBusinessRatesAttachmentUnavailable">@messages("error.businessRatesAttachment.unavailable")</span>
    <span id="signInPageUrl">@{config.basGatewaySignInUrl}</span>
    <span id="startClaimUrl">@{ClaimPropertyRelationshipController.submitRelationship(request.ses.uarn)}</span>
    <span id="submissionId">@submissionId</span>
    <span id="evidenceType">@evidenceType.name</span>
    @javascriptMessages()
    </div>
}
